{# Frames Page - Redesigned for Immersive Experience #}
{% extends "base.html" %}

{% block title %}Frames - HTMLify{% endblock %}

{% block head_content %}
<style>
    body {
        overflow: hidden;
        /* Frame container handles its own scrolling or is full screen */
    }

    .frames-wrapper {
        display: grid;
        grid-template-columns: 320px 1fr;
        height: calc(100vh - 64px);
        background: var(--bg-main);
    }

    /* Sidebar Content */
    .frames-sidebar {
        background: white;
        border-right: 1px solid var(--border-medium);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-light);
    }

    .sidebar-title {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .sidebar-desc {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
    }

    .feed-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .frame-item {
        padding: 1rem;
        background: var(--bg-hover);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: var(--transition-base);
    }

    .frame-item:hover {
        border-color: var(--primary);
        background: white;
        box-shadow: var(--shadow-sm);
        transform: translateX(4px);
    }

    .frame-item.active {
        background: var(--primary-soft);
        border-color: var(--primary);
    }

    .frame-item-title {
        font-size: 0.9375rem;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 0.25rem;
    }

    .frame-item-meta {
        font-size: 0.75rem;
        color: var(--text-dim);
        font-family: var(--font-mono);
    }

    /* Main Frame Area */
    .frame-viewport {
        position: relative;
        background: #f1f5f9;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .viewport-toolbar {
        height: 48px;
        background: white;
        border-bottom: 1px solid var(--border-medium);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.5rem;
        z-index: 10;
    }

    .viewport-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .current-frame-title {
        font-weight: 700;
        font-size: 0.9375rem;
        color: var(--text-main);
    }

    .viewport-actions {
        display: flex;
        gap: 0.5rem;
    }

    .frame-container {
        flex: 1;
        position: relative;
    }

    #frame-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }

    .frame-loader {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5;
    }

    /* Controls Overlay */
    .viewport-controls {
        position: absolute;
        bottom: 2rem;
        right: 2rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        z-index: 20;
    }

    @media (max-width: 1024px) {
        .frames-wrapper {
            grid-template-columns: 1fr;
        }

        .frames-sidebar {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="frames-wrapper">
    <aside class="frames-sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
                Frames Feed
            </h2>
            <p class="sidebar-desc">Discover live rendered previews.</p>
        </div>
        <div class="feed-container" id="feed-container">
            <!-- Items populated by JS -->
            <div class="empty-state p-4">
                <div class="spinner mx-auto mb-3"></div>
                <p>Loading feed...</p>
            </div>
        </div>
    </aside>

    <main class="frame-viewport">
        <div class="viewport-toolbar">
            <div class="viewport-info">
                <span class="badge badge-primary">LIVE VIEW</span>
                <span id="display-title" class="current-frame-title">Select a frame</span>
            </div>
            <div class="viewport-actions">
                <a id="view-source-btn" href="#" class="btn btn-outline btn-sm" target="_blank">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"></polyline>
                        <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    Source
                </a>
                <button id="refresh-btn" class="btn btn-ghost btn-icon btn-sm" title="Refresh">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2v6h-6"></path>
                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                        <path d="M3 22v-6h6"></path>
                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="frame-container">
            <div id="frame-loader" class="frame-loader" style="display: none;">
                <div class="spinner"></div>
            </div>
            <iframe id="frame-iframe" src="/frames/default"></iframe>
        </div>

        <div class="viewport-controls">
            <button id="prev-btn" class="btn btn-secondary btn-icon btn-lg shadow-lg" title="Previous Frame (Up)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
            </button>
            <button id="next-btn" class="btn btn-primary btn-icon btn-lg shadow-lg" title="Next Frame (Down)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </button>
        </div>
    </main>
</div>
{% endblock %}

{% block after_body %}
<script>
    let feed = [];
    let currentIndex = -1;

    async function fetchFeed() {
        try {
            const response = await fetch('/frames/feed');
            const data = await response.json();
            feed = data.feed;
            renderFeed();
            if (feed.length > 0) {
                loadFrame(0);
            }
        } catch (error) {
            console.error('Failed to fetch feed:', error);
            document.getElementById('feed-container').innerHTML = '<div class="alert alert-danger">Failed to load feed.</div>';
        }
    }

    function renderFeed() {
        const container = document.getElementById('feed-container');
        container.innerHTML = '';
        feed.forEach((item, index) => {
            const el = document.createElement('div');
            el.className = `frame-item ${index === currentIndex ? 'active' : ''}`;
            el.innerHTML = `
                <div class="frame-item-title">${item.title || item.name}</div>
                <div class="frame-item-meta">@${item.user.username} â€¢ ${item.path}</div>
            `;
            el.onclick = () => loadFrame(index);
            container.appendChild(el);
        });
    }

    function loadFrame(index) {
        if (index < 0 || index >= feed.length) return;
        currentIndex = index;
        const item = feed[index];

        // Update UI
        document.querySelectorAll('.frame-item').forEach((el, i) => {
            el.classList.toggle('active', i === index);
        });

        document.getElementById('display-title').textContent = item.title || item.name;
        document.getElementById('view-source-btn').href = `/src${item.path}`;

        const iframe = document.getElementById('frame-iframe');
        const loader = document.getElementById('frame-loader');

        loader.style.display = 'flex';
        iframe.src = item.path;

        iframe.onload = () => {
            loader.style.display = 'none';
        };

        // Scroll feed to active item
        const activeItem = document.querySelector('.frame-item.active');
        if (activeItem) {
            activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    document.getElementById('next-btn').onclick = () => loadFrame(currentIndex + 1);
    document.getElementById('prev-btn').onclick = () => loadFrame(currentIndex - 1);
    document.getElementById('refresh-btn').onclick = () => {
        const iframe = document.getElementById('frame-iframe');
        iframe.contentWindow.location.reload();
    };

    // Keyboard navigation
    window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
            loadFrame(currentIndex + 1);
        } else if (e.key === 'ArrowUp') {
            loadFrame(currentIndex - 1);
        }
    });

    fetchFeed();
</script>
{% endblock %}